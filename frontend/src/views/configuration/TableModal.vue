<template>
  <b-modal id="table-modal"
           :active="true"
           has-modal-card
           trap-focus
           aria-role="dialog"
           aria-modal
           @close="onClose">
    <div class="modal-card" style="width: auto">
      <b-loading :active="isLoading" :is-full-page="false"/>

      <header class="modal-card-head">
        <p class="modal-card-title">{{title}}</p>
        <button class="delete"
                aria-label="close"
                @click="onClose">
        </button>
      </header>

      <section class="modal-card-body">
        <b-field v-if="showTableSelect" label="Table">
          <b-select v-model="internalTable.name"
                    placeholder="Select a table"
                    required
                    validation-message="Select a table to add"
                    expanded>
            <option v-for="(table, index) in tables" :key="index" :value="table.name">
              {{ table.name }}
            </option>
          </b-select>
        </b-field>

        <b-field label="Kafka-Topic">
          <b-input placeholder="Enter Kafka-Topic"
                   :required="!schema.topic && !internalTable.topic"
                   validation-message="Add a topic to the table because the schema has none"
                   v-model="internalTable.topic"/>
        </b-field>

        <div class="columns is-1 is-variable">
          <div class="column">
            <b-field label="Record Transaction-ID">
              <b-tooltip label="Add DB transaction ID to JSON data of event?" position="is-right" size="is-small">
                <b-switch v-model="internalTable.yn_record_txid"
                @input="onRecordTxIdChanged"
                true-value="Y"
                false-value="N"/>
              </b-tooltip>
            </b-field>
          </div>
          <div class="column">
            <b-field label="CloudEvents header">
              <b-tooltip label="Add CloudEvents header to each event?" position="is-bottom" size="is-small">
                <b-switch v-model="internalTable.yn_add_cloudevents_header"
                true-value="Y"
                false-value="N"/>
              </b-tooltip>
            </b-field>
          </div>
        </div>

        <b-field label="Kafka Key Handling">
          <b-select v-model="internalTable.kafka_key_handling" expanded>
            <option v-for="option in kafkaKeyHandlingOptions" :key="option.value" :value="option.value" :disabled="optionDisabled(option.value)">
              {{ option.label }}
            </option>
          </b-select>
        </b-field>
        <b-field v-if="internalTable.kafka_key_handling === 'F'" label="Fixed Message Key">
          <b-input v-model="internalTable.fixed_message_key"
                   placeholder="Fixed value for message key"
                   required/>
        </b-field>
        <b-field v-if="internalTable.kafka_key_handling === 'E'" label="Key expression">
          <b-input type="textarea"
                   rows="4"
                   v-model="internalTable.key_expression"
                   placeholder="Message key expression as SQL statement or SQL expression which returns a single value.
You can use the pseudo-records :new and :old of the trigger in the expression definition.
At trigger generation these pseudo record aliases are adjusted to the operation (insert and update uses :new, delete uses :old).
If the expression is not a SQL statement then it is treated as a direct assignment e.g. of a column value.
Example expressions:
- :new.ID
- SELECT Company FROM Other_Table WHERE ID=:new.Other_Table_ID"
                   required/>
        </b-field>

        <b-field label="Info">
          <b-input type="textarea"
                   rows="1"
                   v-model="internalTable.info"
                   required
                   validation-message="Add an info text why this table is used in MOVEX Change Data Capture"/>
        </b-field>

          <div class="columns is-1 is-variable">
            <div class="column">
              <b-field label="Initialize data">
                <b-tooltip label="Initially transfer existing records as insert events at next deployment?" position="is-right" size="is-small">
                  <b-switch v-model="internalTable.yn_initialization"
                            true-value="Y"
                            false-value="N"/>
                </b-tooltip>
              </b-field>
            </div>
            <div class="column">
              <b-field label="Use flashback query" v-if="internalTable.yn_initialization === 'Y'">
                <b-tooltip label="Use flashback query up to the create trigger SCN?" position="is-bottom" size="is-small">
                  <b-switch v-model="internalTable.yn_initialize_with_flashback"
                            true-value="Y"
                            false-value="N"/>
                </b-tooltip>
              </b-field>
            </div>
          </div>

        <b-field label="Optional filter expression for initial transfer" v-if="internalTable.yn_initialization === 'Y'">
          <b-input type="textarea"
                   rows="1"
                   v-model="internalTable.initialization_filter"/>
        </b-field>

        <b-field label="Optional order by expression for initial transfer" v-if="internalTable.yn_initialization === 'Y'">
          <b-input type="textarea"
                   rows="1"
                   v-model="internalTable.initialization_order_by"/>
        </b-field>

        <template v-if="!isAddMode">
          <b-field label="Date Of Last Trigger Deployment" custom-class="is-small" class="trigger-dates">
            <div class="columns is-1 is-variable">
              <div class="column">
                <b-field label="Insert" custom-class="is-small has-text-grey">
                  <b-input size="is-small" disabled :value="triggerDates.youngest_insert_trigger_changed_at"/>
                </b-field>
              </div>
              <div class="column">
                <b-field label="Update" custom-class="is-small has-text-grey">
                  <b-input size="is-small" disabled :value="triggerDates.youngest_update_trigger_changed_at"/>
                </b-field>
              </div>
              <div class="column">
                <b-field label="Delete" custom-class="is-small has-text-grey">
                  <b-input size="is-small" disabled :value="triggerDates.youngest_delete_trigger_changed_at"/>
                </b-field>
              </div>
            </div>
          </b-field>
        </template>
      </section>

      <footer class="modal-card-foot" :class="isAddMode ? 'flex-end' : 'space-between'">
        <b-button v-if="!isAddMode"
                  id="delete-table-button"
                  type="is-danger"
                  @click="onRemove">
          Remove from observation
        </b-button>
        <b-button id="save-table-button"
                  type="is-primary"
                  @click="onSave"
                  :loading="isSaving">
  Save
        </b-button>
      </footer>
    </div>
  </b-modal>
</template>

<script>
import CRUDService from '@/services/CRUDService';
import { getErrorMessageAsHtml } from '@/helpers';

export default {
  name: 'TableModal',
  props: {
    tables: { type: Array, default: () => [] },
    table: { type: Object, default: () => {} },
    schema: { type: Object, default: () => {} },
  },
  data() {
    return {
      isLoading: false,
      isSaving: false,
      internalTable: { ...this.table },
      triggerDates: {},
      kafkaKeyHandlingOptions: [
        { value: 'N', label: 'None' },
        { value: 'F', label: 'Fixed Key' },
        { value: 'P', label: 'Primary Key' },
        { value: 'T', label: 'Transaction-ID' },
        { value: 'E', label: 'Expression' },
      ],
    };
  },
  async created() {
    if (!this.isAddMode) {
      this.triggerDates = await CRUDService.tables.triggerDates(this.table.id);
      if (!this.triggerDates.youngest_insert_trigger_changed_at) {
        this.triggerDates.youngest_insert_trigger_changed_at = 'never';
      }
      if (!this.triggerDates.youngest_update_trigger_changed_at) {
        this.triggerDates.youngest_update_trigger_changed_at = 'never';
      }
      if (!this.triggerDates.youngest_delete_trigger_changed_at) {
        this.triggerDates.youngest_delete_trigger_changed_at = 'never';
      }
    }
  },
  computed: {
    title() {
      if (this.isAddMode) {
        return 'Add table to observe';
      }
      return `Edit observed table (${this.internalTable.name})`;
    },
    showTableSelect() {
      return this.isAddMode;
    },
    isAddMode() {
      return this.table.id === null;
    },
  },
  methods: {
    optionDisabled(value) {
      return value === 'T' && this.internalTable.yn_record_txid === 'N';
    },
    onRecordTxIdChanged(value) {
      // reset 'kafka_key_handling' to N(one) if recording of transaction id changed to disabled
      // and 'kafka_key_handling' is currently T(ransaction)
      if (value === 'N' && this.internalTable.kafka_key_handling === 'T') {
        this.internalTable.kafka_key_handling = 'N';
      }
    },
    onClose() {
      this.$emit('close');
    },
    async onRemove() {
      try {
        this.isLoading = true;
        await CRUDService.tables.delete(this.internalTable.id, this.internalTable);
        this.$emit('removed', this.internalTable);
      } catch (e) {
        this.$buefy.notification.open({
          message: getErrorMessageAsHtml(e),
          type: 'is-danger',
          indefinite: true,
          position: 'is-top',
        });
      } finally {
        this.isLoading = false;
      }
    },
    async onSave() {
      const invalidElements = this.$el.querySelectorAll(':invalid');
      if (invalidElements.length > 0) {
        invalidElements.forEach((e) => e.reportValidity());
        return;
      }

      try {
        this.isSaving = true;
        if (this.internalTable.id) {
          const updatedTable = await CRUDService.tables.update(this.internalTable.id, { table: this.internalTable });
          this.$emit('updated', updatedTable);
        } else {
          const createdTable = await CRUDService.tables.create({ table: this.internalTable });
          this.$emit('created', createdTable);
        }
      } catch (e) {
        this.$buefy.notification.open({
          message: getErrorMessageAsHtml(e),
          type: 'is-danger',
          indefinite: true,
          position: 'is-top',
        });
      } finally {
        this.isSaving = false;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
  .space-between {
    justify-content: space-between;
  }
  .flex-end {
    justify-content: flex-end;
  }
  .trigger-dates {
    margin-top: 2rem;
  }
  select {
    option[disabled] {
      color: darkgray;
    }
  }
</style>
